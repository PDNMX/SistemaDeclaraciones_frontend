<div fxFill fxLayout="column">
  <app-header class="mg-btm-80px"></app-header>
  <div class="contenedor" *ngIf="userInstitucion !== null; else registerInstitucion">
    <mat-toolbar class="background-white title-toolbar flex mg-top-100px">
      <label class="step-title">Lista de declaraciones {{ userID ? 'usuario' : '' }}</label>
    </mat-toolbar>
    <mat-divider class="mg-height-50px-30px"></mat-divider>

    <div class="pd-lateral">
      <!--
        - (selectedTabChange): Evento que se dispara al cambiar de pestaña. Llama a onTabChange.
        - #tabGroup: Referencia a este componente para poder acceder a él desde el .ts.
      -->
      <mat-tab-group mat-align-tabs="center" (selectedTabChange)="onTabChange($event)" #tabGroup>
        <mat-tab label="Todas">
          <ng-template matTabContent>
            <div class="main-table-container mat-elevation-z8">
              <div class="table-container">
                <!--
                  - matSortDirection: Dirección del ordenamiento por defecto ('desc' para descendente).
                  - #totalSort="matSort": Crea una variable de referencia para que el componente .ts pueda acceder a este MatSort.
                  - (matSortChange): Evento que se dispara al hacer clic en un encabezado para ordenar.
                                     Llama al nuevo manejador central 'triggerTableUpdate'.
                 -->
                <table mat-table [dataSource]="data" matSort matSortDisableClear matSortActive="updatedAt" matSortDirection="desc" #totalSort="matSort" (matSortChange)="triggerTableUpdate($event)">
                  <ng-container matColumnDef="tipoDeclaracion">
                    <!-- mat-sort-header: Hace que esta cabecera de columna sea clickeable para ordenar. -->
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
                    <td mat-cell *matCellDef="let row">{{ row.tipoDeclaracion }}</td>
                  </ng-container>

                  <ng-container matColumnDef="declaracionCompleta">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Simplificada</th>
                    <td mat-cell *matCellDef="let row">{{ row.declaracionCompleta ? 'NO' : 'SÍ' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="owner">
                    <!-- Se puede especificar un nombre de campo diferente para ordenar, útil para campos anidados. -->
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="owner.username">Declarante</th>
                    <td mat-cell *matCellDef="let row">{{ row.owner?.username }}</td>
                  </ng-container>

                  <ng-container matColumnDef="firmada">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus</th>
                    <td mat-cell *matCellDef="let row">{{ row.firmada ? 'FINALIZADA' : 'EN PROGRESO' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="updatedAt">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Última actualización</th>
                    <td mat-cell *matCellDef="let row">{{ row.updatedAt | date : 'dd/MM/yyyy' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="actions" *ngIf="isSuperAdmin || isRoot">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                    <td mat-cell *matCellDef="let row" class="text-center">
                      <button
                        *ngIf="isSuperAdmin || isRoot"
                        mat-icon-button
                        (click)="previewDeclaration(row._id)"
                        [disabled]="!row.firmada"
                        matTooltip="Ver detalle de la declaración"
                      >
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button
                        *ngIf="isSuperAdmin || isRoot"
                        mat-icon-button
                        (click)="previewDeclaration(row._id, true)"
                        [disabled]="!row.firmada"
                        matTooltip="Ver datos públicos de la declaración"
                      >
                        <mat-icon>folder_shared</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
              </div>
              <mat-paginator [length]="total" [pageSize]="pageSizeOptions[0]" [pageSizeOptions]="pageSizeOptions" #totalPaginator (page)="triggerTableUpdate($event)"></mat-paginator>
            </div>
          </ng-template>
        </mat-tab>

        <mat-tab label="Inicial">
          <div class="main-table-container mat-elevation-z8">
            <div class="table-container">
              <table mat-table [dataSource]="dataInicial" matSort matSortDisableClear matSortActive="updatedAt" matSortDirection="desc" #inicialSort="matSort" (matSortChange)="triggerTableUpdate($event)">
                <ng-container matColumnDef="tipoDeclaracion">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
                  <td mat-cell *matCellDef="let row">{{ row.tipoDeclaracion }}</td>
                </ng-container>

                <ng-container matColumnDef="declaracionCompleta">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Simplificada</th>
                  <td mat-cell *matCellDef="let row">{{ row.declaracionCompleta ? 'NO' : 'SÍ' }}</td>
                </ng-container>

                <ng-container matColumnDef="owner">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="owner.username">Declarante</th>
                  <td mat-cell *matCellDef="let row">{{ row.owner?.username }}</td>
                </ng-container>

                <ng-container matColumnDef="firmada">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus</th>
                  <td mat-cell *matCellDef="let row">{{ row.firmada ? 'FINALIZADA' : 'EN PROGRESO' }}</td>
                </ng-container>

                <ng-container matColumnDef="updatedAt">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Última actualización</th>
                  <td mat-cell *matCellDef="let row">{{ row.updatedAt | date : 'dd/MM/yyyy' }}</td>
                </ng-container>

                <ng-container matColumnDef="actions" *ngIf="isSuperAdmin || isRoot">
                  <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                  <td mat-cell *matCellDef="let row" class="text-center">
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver detalle de la declaración"
                    >
                      <mat-icon>visibility</mat-icon>
                    </button>
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id, true)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver datos públicos de la declaración"
                    >
                      <mat-icon>folder_shared</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
            <mat-paginator [length]="totalInicial" [pageSize]="pageSizeOptions[0]" [pageSizeOptions]="pageSizeOptions" #inicialPaginator (page)="triggerTableUpdate($event)"></mat-paginator>
          </div>
        </mat-tab>

        <mat-tab label="Modificación">
          <div class="main-table-container mat-elevation-z8">
            <div class="table-container">
              <table mat-table [dataSource]="dataModificacion" matSort matSortDisableClear matSortActive="updatedAt" matSortDirection="desc" #modificacionSort="matSort" (matSortChange)="triggerTableUpdate($event)">
                <ng-container matColumnDef="tipoDeclaracion">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
                  <td mat-cell *matCellDef="let row">{{ row.tipoDeclaracion }}</td>
                </ng-container>

                <ng-container matColumnDef="declaracionCompleta">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Simplificada</th>
                  <td mat-cell *matCellDef="let row">{{ row.declaracionCompleta ? 'NO' : 'SÍ' }}</td>
                </ng-container>

                <ng-container matColumnDef="owner">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="owner.username">Declarante</th>
                  <td mat-cell *matCellDef="let row">{{ row.owner?.username }}</td>
                </ng-container>

                <ng-container matColumnDef="firmada">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus</th>
                  <td mat-cell *matCellDef="let row">{{ row.firmada ? 'FINALIZADA' : 'EN PROGRESO' }}</td>
                </ng-container>

                <ng-container matColumnDef="updatedAt">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Última actualización</th>
                  <td mat-cell *matCellDef="let row">{{ row.updatedAt | date : 'dd/MM/yyyy' }}</td>
                </ng-container>

                <ng-container matColumnDef="actions" *ngIf="isSuperAdmin || isRoot">
                  <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                  <td mat-cell *matCellDef="let row" class="text-center">
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver detalle de la declaración"
                    >
                      <mat-icon>visibility</mat-icon>
                    </button>
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id, true)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver datos públicos de la declaración"
                    >
                      <mat-icon>folder_shared</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
            <mat-paginator [length]="totalModificacion" [pageSize]="pageSizeOptions[0]" [pageSizeOptions]="pageSizeOptions" #modificacionPaginator (page)="triggerTableUpdate($event)"></mat-paginator>
          </div>
        </mat-tab>

        <mat-tab label="Final">
          <div class="main-table-container mat-elevation-z8">
            <div class="table-container">
              <table mat-table [dataSource]="dataConclusion" matSort matSortDisableClear matSortActive="updatedAt" matSortDirection="desc" #conclusionSort="matSort" (matSortChange)="triggerTableUpdate($event)">
                <ng-container matColumnDef="tipoDeclaracion">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
                  <td mat-cell *matCellDef="let row">{{ row.tipoDeclaracion }}</td>
                </ng-container>

                <ng-container matColumnDef="declaracionCompleta">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Simplificada</th>
                  <td mat-cell *matCellDef="let row">{{ row.declaracionCompleta ? 'NO' : 'SÍ' }}</td>
                </ng-container>

                <ng-container matColumnDef="owner">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="owner.username">Declarante</th>
                  <td mat-cell *matCellDef="let row">{{ row.owner?.username }}</td>
                </ng-container>

                <ng-container matColumnDef="firmada">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus</th>
                  <td mat-cell *matCellDef="let row">{{ row.firmada ? 'FINALIZADA' : 'EN PROGRESO' }}</td>
                </ng-container>

                <ng-container matColumnDef="updatedAt">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Última actualización</th>
                  <td mat-cell *matCellDef="let row">{{ row.updatedAt | date : 'dd/MM/yyyy' }}</td>
                </ng-container>

                <ng-container matColumnDef="actions" *ngIf="isSuperAdmin || isRoot">
                  <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                  <td mat-cell *matCellDef="let row" class="text-center">
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver detalle de la declaración"
                    >
                      <mat-icon>visibility</mat-icon>
                    </button>
                    <button
                      *ngIf="isSuperAdmin || isRoot"
                      mat-icon-button
                      (click)="previewDeclaration(row._id, true)"
                      [disabled]="!row.firmada"
                      matTooltip="Ver datos públicos de la declaración"
                    >
                      <mat-icon>folder_shared</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
            <mat-paginator [length]="totalConclusion" [pageSize]="pageSizeOptions[0]" [pageSizeOptions]="pageSizeOptions" #conclusionPaginator (page)="triggerTableUpdate($event)"></mat-paginator>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
    <mat-divider class="mg-top-100px"></mat-divider>
  </div>
  <ng-template #registerInstitucion>
    <mat-toolbar class="background-white title-toolbar">
      <label class="step-title" style="color: red"
        >Es necesario que registres la institución a la que perteneces en la sección <strong>MI PERFIL</strong> para
        poder continuar.</label
      >
    </mat-toolbar>
    <div class="contenedor">
      <mat-divider class="mg-height-50px-30px"></mat-divider>
      <br />
      <div class="center">
        <button mat-raised-button color="primary" routerLink="/perfil">ir a MI PERFIL</button>
      </div>
    </div>
  </ng-template>
  <app-footer></app-footer>
</div>